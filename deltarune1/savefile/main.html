<html>

<head>
  <title>Editor</title>


  <meta name="author" content="">
  <meta http-equiv="content-type" content="text/html; charset = UTF-8">

  <meta name="theme-color" content="#000000">

  <meta name="robots" content="noindex,nofollow">


  <link rel="icon" href="https://spamton.com/favicon.ico">
  <script src="../../lib/jquery.min-2.js"></script>
  <link rel="stylesheet" href="../../css/deltarune2savefile-2.css?nocache=101">
  <link rel="stylesheet" href="../../lib/jquery-ui-2.css">
  <script src="../../lib/jquery-ui.min-2.js"></script>
  <!--<script src="/socket.io/socket.io.js"></script>-->
  <script src="../../lib/jquery.tancolor-2.js"></script>
  <link href="../../css2-3?family=Ubuntu:wght@500&display=swap" rel="stylesheet">

  <script src="../../lib/FileSaver.min-2.js"></script>
  <script src="../../js/dataNames.js?nocache=101"></script>
  <script src="../../js/generateInput-2.js?nocache=101"></script>
  <script src="../../js/extraFunctions-2.js?nocache=101"></script>
  <script src="../../js/generateFormCh1.js?nocache=101"></script>
  <script src="../../js/thrasher-2.js?nocache=101"></script>
  <script src="../../js/goner-2.js?nocache=101"></script>
</head>

<body>
  <center>
    <h1>Deltarune存档修改器v5.0</h1>
  </center>
  <br><br><br>
  <div id='page_tabs'></div>

  <div id='uploadForm'>
    <div id='saveData'>
      <div id='js_err_010'>
        <br><br><br>
        <h1>
          <center>加载错误，联系开发者解决</center>
        </h1>
      </div>

    </div>

    <br><br><br>
    <center>
      <div class='submitButton'>确认修改（请事先备份）</div>
    </center>
  </div>

  <br>
  <center>
    保存类型(不支持)：<select name="public_save_type">`
      <option value="1" selected="">Chapter 1</option>
      <option value="2">Chapter 2 (Experimental)</option>
    </select><br><br>

    <p>由Bilibili:@秋冥散雨_GenOuka完成所有界面、描述文本的汉化和修改工作，均为手工翻译。原版修改器(英文)：https://saveeditor.spamton.com/</p>
    <p>物品名称、房间名称的汉化由Bilibili:@chztd完成</p>
  </center>

  <br><br><br><br><br>

  <center>
  </center>

  <script>
    Cwindow=window;
    (async function () {
      function convertStringToObject(str) {
        if (str === undefined || str == null || str.trim() === "") {
          return {};
        }
        const lines = str.split('\n');
        const result = {};
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          if (line.trim() !== '') {  // 检查非空行（忽略首尾空白）
            const lineNumber = i + 1;  // 行号从1开始计数
            result[`_${lineNumber}`] = line.trim();
          }
        }
        return result;
      }
      function readSaveSafe() {
        function sync2async(func) {
          return new Promise((resolve, reject) => {
            try {
              const result = func();
              resolve(result);
            } catch (error) {
              reject(error);
            }
          });
        }
        if (window.Android) {
          return sync2async(() => window.Android.readFile11());
        }
        else if (window.__TAURI_INTERNALS__) {
          (function () {
            window.Android = {
              readFile11: () => window.__TAURI__.core.invoke('read_file_11', { href: location.href }),
              writeSyncT: (text) => window.__TAURI__.core.invoke('write_sync_t', { href: location.href, text }),
              closeDialogT: () => {
                const base = 'https://dreditorcn.genouka.top';
                const platform = window.Android.getPlatform();
                const ok = `${base}/win/success.html?reason=closeDialogT`;
                location.href = ok;
              },
              getPlatform: () => window.__TAURI__.core.invoke('get_platform'),
              getSaveDirectory: () => window.__TAURI__.core.invoke('get_save_directory')
            };
          })();
          return Android.readFile11();
        } else {
          alert("错误，未运行在合法环境，目前支持Tauri版本和Android版本");
          return sync2async(() => { throw new Error("错误，未运行在合法环境，目前支持Tauri版本和Android版本"); });
        }
      }
      window.savedata1 = await readSaveSafe();
      window.saveData = convertStringToObject(savedata1);
      //console.log(saveData);
      //@bilibili:genouka
      Cwindow._col1 = colorToRGB(saveData[`_541`]);
      Cwindow._col2 = colorToRGB(saveData[`_542`]);
      Cwindow._col3 = colorToRGB(saveData[`_543`]);

      Cwindow.allow_broken_party = false;


      $(function () {

        if (saveData["err"] != null) {
          console.log(saveData["err"]);
        }

        $("#page_tabs").html(`

      <div class='tab_click' tab='tab_main'>主要</div>
      <div class='tab_click' tab='tab_party'>队伍</div>
      <div class='tab_click' tab='tab_items'>物品</div>
      <div class='tab_click' tab='tab_creations'>造物</div>
      <div class='tab_click' tab='tab_hometown'>小镇</div>
      <div class='tab_click' tab='tab_other'>其他标志</div>
      <div class='tab_click' tab='tab_all'>显示全部</div>

    `);

        function switchTab(tab) {
          if (tab != "tab_all") {
            $(`.tab`).css({ "display": "none" });
            $(`#${tab}`).css({ "display": "inherit" });
          } else {
            $(`.tab`).css({ "display": "inherit" });
          }



          $(`.tab_click`).removeClass("tab_selected");
          $(`.tab_click[tab='${tab}']`).addClass("tab_selected");

        }

        $("#page_tabs").on('click', '.tab_click', function () {
          switchTab($(this).attr("tab"));
        });




        $("body").on('change', 'select', function () {
          Cwindow.enabled = true;
          if ($(this).val() == 0 && $(this).parent().attr('class').indexOf('grey_disable') != -1) {
            enabled = false;
          }

          if (enabled) {
            $(this).css({ "color": "#FFFFFF" });
          }
          else {
            $(this).css({ "color": "#777777" });
          }

          updateStatus();


          //This is the party logic
          Cwindow._name = $(this).attr('name');
          if (_name == "_8" || _name == "_9" || _name == "_10") {
            //slot1


            SetValidParty($(`select[name="_8"]`).val(), $(`select[name="_9"]`).val(), $(`select[name="_10"]`).val());

          }


          if (_name == "_538" || _name == "_539" || _name == "_540" || _name == "_541" || _name == "_542" || _name == "_543") {
            updateThrasher();
          }


          if (_name = 'public_save_type') {
            updateDownloadChapter();
          }



        });


        function updateDownloadChapter() {
          Cwindow.save_type = $(`select[name='public_save_type']`).val();
          console.log(save_type);
          Cwindow.public_href = '../../dl/1750859627716/685bff6b17c67992e64e90a0/filech1_0';
          Cwindow.public_text = "Public Save File Link";

          if (save_type == 2) {

            Cwindow.oldFile = "filech1_0";
            Cwindow.convertName = oldFile;
            if (convertName.indexOf('filech1') != -1) {
              convertName = convertName.replace('filech1', 'filech2');
            } else {
              convertName = "filech2_0";
            }

            public_href = `../../dl/1750859627716/685bff6b17c67992e64e90a0/ch2/${convertName}`;
            public_text = "Public Save File Link (Converted to Chapter 2)";
          }



        }
        updateDownloadChapter();

        $("body").on('change', 'input', function () {


          Cwindow._name = $(this).attr('name');

          updateStatus();

          if (_name == "_1217" || _name == "_1218" || _name == "_1219") {
            updateGoner(1217, 1218, 1219);
          }


          Cwindow.enabled = true;

          if ($(this).attr('type') == "checkbox") {
            if (!this.checked) {
              enabled = false;
            }
          }


          if (enabled) {
            $(this).parent().css({ "color": "#FFFFFF" });
          }
          else {
            $(this).parent().css({ "color": "#777777" });
          }

          if ($(this).attr('name') == "show_all_recruits") {
            if (this.checked) {
              $(".unused_recruit").css({
                "display": "block"
              });
            } else {
              $(".unused_recruit").css({
                "display": "none"
              });
            }

          }

          if ($(this).attr('name') == "show_all_rooms") {
            if (this.checked) {
              $(".room_id").html(generateSelectCh1(`_10317`, "房间编码", $(`select[name="_10317"]`).val(), rooms_all));

            } else {

              $(".room_id").html(generateSelectCh1(`_10317`, "房间编码", $(`select[name="_10317"]`).val(), roomsCh1));

            }

          }


          if ($(this).attr('name') == "show_all_recruits_cafe") {
            if (this.checked) {
              $(".unused_recruit_cafe").css({
                "display": "block"
              });
            } else {
              $(".unused_recruit_cafe").css({
                "display": "none"
              });
            }

          }

          if ($(this).attr('name') == "allow_broken_party") {
            if (this.checked) {
              allow_broken_party = true;

            } else {
              allow_broken_party = false;
              $(".broken_party").removeClass('broken_party');
            }

            SetValidParty($(`select[name="_8"]`).val(), $(`select[name="_9"]`).val(), $(`select[name="_10"]`).val());
          }





        });



        function SetValidParty(val1, val2, val3) {

          val1 = parseInt(val1);
          val2 = parseInt(val2);
          val3 = parseInt(val3);


          Cwindow.val1_arr = [1];
          Cwindow.val2_arr = [0];
          Cwindow.val3_arr = [0];



          if (allow_broken_party) {
            val1_arr = [0, 1, 2, 3];
            val2_arr = [0, 1, 2, 3];
            val3_arr = [0, 1, 2, 3];
          } else {
            val1_arr = [1];
            val2_arr = [];
            val3_arr = [];
            if (val2 != 0) {

              if (val3 == 0) {
                val2_arr.push(0);
              }

              for (Cwindow.i = 2; i < 4; i++) {
                if (i != val3) {
                  val2_arr.push(i);
                }
              }

              val3_arr.push(0);
              for (Cwindow.i = 2; i < 4; i++) {
                if (i != val2) {
                  val3_arr.push(i);
                }
              }

            } else {
              val2_arr = [2, 3];
              val3_arr = [0];
            }

          }
          Cwindow.final_arr = [val1_arr, val2_arr, val3_arr];
          for (Cwindow.j = 0; j < 3; j++) {

            $(`select[name="_${j + 8}"]`).find('option').each(function () {
              Cwindow.allowed = false;
              for (Cwindow.i = 0; i < final_arr[j].length; i++) {
                if (`${final_arr[j][i]}` === $(this).val()) {
                  allowed = true;
                }
              }
              if (allowed) {
                $(this).removeClass('broken_party');
              } else {
                $(this).addClass('broken_party');
              }
            });
          }





          $("#party_display").html(`${getPartyImage(val1)} ${getPartyImage(val2)} ${getPartyImage(val3)}`);

          function getPartyImage(val) {
            Cwindow.str = "<span style='vertical-align:bottom;width:40px;height:40px;display:inline-block;'></span>";
            switch (val) {
              case 1:
                str = "<img src='../../images/Kris.png'>";
                break;
              case 2:
                str = "<img src='../../images/Susie.png'>";
                break;
              case 3:
                str = "<img src='../../images/Ralsei.png'>";
                break;
            }
            return str;
          }

        }




        $("body").on('click', '.spells_title', function () {
          Cwindow.display = 'flex';
          Cwindow.text = `<center>▲ 技能 ▲</center>`;
          if ($(this).parent().find(".spell_wrapper").css("display") == 'flex') {
            display = 'none';

            text = `<center>▼ 技能 ▼</center>`


          }
          $(this).html(text);
          $(this).parent().find(".spell_wrapper").css({ "display": display })
        });


        $("#saveData").html(generateForm(saveData));


        $("#thrash_head_c_slider").slider({
          min: 0,
          max: 31,
          value: parseInt($(`input[name="_540"]`).val()),
          slide: function (event, ui) {
            $(`input[name="_540"]`).val(ui.value);
            updateThrasher();
          }
        });

        $("#thrash_body_c_slider").slider({
          min: 0,
          max: 31,
          value: parseInt($(`input[name="_541"]`).val()),
          slide: function (event, ui) {
            $(`input[name="_541"]`).val(ui.value);
            updateThrasher();
          }
        });

        $("#thrash_feet_c_slider").slider({
          min: 0,
          max: 31,
          value: parseInt($(`input[name="_542"]`).val()),
          slide: function (event, ui) {
            $(`input[name="_542"]`).val(ui.value);
            updateThrasher();
          }
        });


        function updateThrasher() {
          Cwindow._col1 = colorToRGB($(`input[name='_540']`).val());
          Cwindow._col2 = colorToRGB($(`input[name='_541']`).val());
          Cwindow._col3 = colorToRGB($(`input[name='_542']`).val());
          GenerateThrasher($(`select[name='_537']`).val(), $(`select[name='_538']`).val(), $(`select[name='_539']`).val(), _col1, _col2, _col3);

          $("#thrash_head_c").css({ "background-color": `rgb(${_col1[0]},${_col1[1]},${_col1[2]})` });
          $("#thrash_body_c").css({ "background-color": `rgb(${_col2[0]},${_col2[1]},${_col2[2]})` });
          $("#thrash_feet_c").css({ "background-color": `rgb(${_col3[0]},${_col3[1]},${_col3[2]})` });

        }
        updateThrasher();


        function updateStatus() {
          /*
      
          //This needs to be updated for chapter 1. Will do later
      
          Cwindow.lv_kris = "1";
          Cwindow.lv_susie = "1";
          Cwindow.lv_ralsei = "1";
          Cwindow.status_kris = "Leader";
          Cwindow.status_susie = "Dark Knight";
          Cwindow.status_ralsei = "Dark Prince";
          Cwindow.desc_kris = "Commands the party<br>with various ACTs.";
          Cwindow.desc_susie = "Does damage using<br>dark energy";
          Cwindow.desc_ralsei = "Dark-World being.<br>Has friends now.";
      
      
          if($(`input[name='_3053']`).val() >= 60){
            status_kris = "Tactician";
            desc_kris = "Commands the party<br>by ACTs. Sometimes.";
          }
      
          if($(`input[name='_3053']`).val() >= 200){
            lv_kris = "2";
            lv_susie = "2";
            lv_ralsei = "2";
          }
      
      
      
          if($(`select[name='_805']`).val() > 0){
            status_kris = "Bed Inspector";
            desc_kris = "Inspects all beds<br>inexplicably.";
          }
      
      
          $("#status_kris").html(`LV${lv_kris} ${status_kris}<br><div class='status_desc'>${desc_kris}</div>`);
          $("#status_susie").html(`LV${lv_susie} ${status_susie}<br><div class='status_desc'>${desc_susie}</div>`);
          $("#status_ralsei").html(`LV${lv_ralsei} ${status_ralsei}<br><div class='status_desc'>${desc_ralsei}</div>`);
      
          */
        }

        updateStatus();


        updateGoner(1217, 1218, 1219);
        switchTab("tab_main"); function mergeObjects() {

          Cwindow.result = {};

          // 遍历所有传入的对象

          for (Cwindow.i = 0; i < arguments.length; i++) {

            Cwindow.obj = arguments[i];

            // 遍历当前对象的所有属性

            for (Cwindow.key in obj) {

              // 确保只复制对象自身的属性（非继承属性）

              if (obj.hasOwnProperty(key)) {

                result[key] = obj[key];

              }

            }

          }

          return result;

        }


        function objectToMultilineString(obj, totalLines) {
          const lines = Array(totalLines).fill(''); // 创建总行数的空行数组

          // 填充非空行内容
          for (const [key, value] of Object.entries(obj)) {
            if (key.startsWith('_')) {
              const lineNum = parseInt(key.substring(1));
              if (lineNum > 0 && lineNum <= totalLines) {
                lines[lineNum - 1] = value;
              }
            }
          }

          return lines.join('\n');
        }

        SetValidParty($(`select[name="_8"]`).val(), $(`select[name="_9"]`).val(), $(`select[name="_10"]`).val());

        $(".submitButton").on('click', function () {
          Cwindow.formdata = parseFormData();
          Android.writeSyncT(objectToMultilineString(mergeObjects(saveData, formdata), 10318)); Android.closeDialogT();


        });


        $('#uploadForm').submit(function (e) {
          e.preventDefault();
        });


        function parseFormData() {
          formData = {};

          $("select").each(function () {
            if ($(this).attr('noinput') != "true") {
              formData[$(this).attr('name')] = $(this).val();
            }
          });

          $("input").each(function () {
            if ($(this).attr('noinput') != "true") {
              Cwindow.inputData = "0";
              if ($(this).attr("type") == "checkbox") {

                Cwindow._off = "0";
                Cwindow._on = "1";

                if ($(this).attr("off")) {
                  _off = $(this).attr("off");
                }

                if ($(this).attr("on")) {
                  _on = $(this).attr("on");
                }
                inputData = ($(this).prop('checked') ? _on : _off);
              } else {
                inputData = $(this).val();
              }


              formData[$(this).attr('name')] = inputData;
            }
          });
          return formData;
        }

      });

    })();
  </script>
</body>

</html>